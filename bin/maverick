#!/bin/bash

# If tput is available, populate colour variables
if hash tput 2>/dev/null; then
    bgbl=$(tput setab 0)
    bgr=$(tput setab 1)
    bgg=$(tput setab 2)
    bgb=$(tput setab 4)
    bgw=$(tput setab 7)
    bold=$(tput bold)
    red=$(tput setaf 1)
    green=$(tput setaf 2)
    blue=$(tput setaf 4)
    white=$(tput setaf 7)
    reset=$(tput sgr0)
fi

echo
echo "${bgb}${bold}Maverick - UAV Companion Computer Automation${reset}"
echo

# Check that we're root or mav user
if [[ $EUID -ne 0 && $USER != "mav" ]]; then
    echo "Error: This must be run as root or mav user"
    echo
    exit 1
fi

# Define usage function
usage () {
    echo "--configure                               Configure system - ${bold}BEWARE this may do major changes to your existing system${reset}"
    echo "--env=[bootstrap|dev|production]          Environment to configure: bootstrap, dev or production"
    echo "--status                                  Show current running status"
    echo "--info                                    Display system information"
    echo "--netinfo                                 Display network information"
    echo "--self-update                             Update to latest maverick code"
    echo
    echo "${bgr}${bold}WARNING: Maverick may make major changes to the system is it running on.${reset}"
    echo "${bgr}${bold}Please do not run without understanding what it does.${reset}"
    echo
    exit 1
}

if [[ $# -eq 0 ]] ; then
    usage
fi

# Parse arguments
for i in "$@"
do
    case $i in
        --env=*)
            ENV="${i#*=}"
            shift
            ;;
        --configure)
            CONFIGURE="true"
            shift
            ;;
        --status)
            STATUS="true"
            shift
            ;;
        --info)
            INFO="true"
            shift
            ;;
        --netinfo)
            NETINFO="true"
            shift
            ;;
        --self-update)
            SELFUPDATE="true"
            shift
            ;;
        *)
            echo "Error: argument not recognised"
            echo
            usage
            ;;
    esac
done

mavenv () {
    if [ "x$1" == "xdev" ]; then
        echo "Maverick Environment:   ${bgr}${white}${bold} dev ${reset}"
    elif [ "x$1" == "xproduction" ]; then
        echo "Maverick Environment:   ${bgg}${white}${bold} production ${reset}"
    elif [ "x$1" == "xbootstrap" ]; then
        echo "Maverick Environment:   ${bgb}${white}${bold} bootstrap ${reset}"
    fi    
}

# If self-update set, action and then exit
if [ "$SELFUPDATE" == "true" ]; then
    if [ -e /srv/maverick/software/maverick/conf/puppet.conf ]; then
        if [ $EUID -eq 0 ]; then
            su mav -c "cd /srv/maverick/software/maverick; git pull origin"
        elif [ $USER == "mav" ]; then
            cd /srv/maverick/software/maverick; git pull origin;
        fi
        echo
        echo "${bgg}Maverick update completed${reset}"
        echo
    else
        echo
        echo "${bgr}Error: Maverick not found in expected location: /srv/maverick/software/maverick${reset}"
        echo
    fi
    exit 0
fi

# If info set, action and then exit
if [ "$INFO" == "true" ]; then
    if [ -e /srv/maverick/.environment ]; then
        environment=$(cat /srv/maverick/.environment)
    fi
    mavenv ${environment}
    echo
    /usr/bin/python /srv/maverick/software/maverick/bin/maverick-info
    echo
    exit 0
fi

# If netinfo set, action and then exit
if [ "$NETINFO" == "true" ]; then
    if [ -e /srv/maverick/.environment ]; then
        environment=$(cat /srv/maverick/.environment)
    fi
    mavenv ${environment}
    echo
    /usr/bin/python /srv/maverick/software/maverick/bin/maverick-netinfo
    echo
    exit 0
fi

# If status set, action and then exit
if [ "$STATUS" == "true" ]; then
    status () {
        if [ $2 -eq 0 ]; then
            echo "$1: ${green}Running${reset}\n"
        else
            echo "$1: ${red}Stopped${reset}\n"
        fi
    }
    if [ -e /srv/maverick/.environment ]; then
        environment=$(cat /srv/maverick/.environment)
    fi
    mavenv ${environment}
    echo
    (systemctl status mavproxy-fc >/dev/null 2>&1); statusout+=$(status "Mavproxy (Flight Controller)" $?)
    $(systemctl -a |grep mavros-fc >/dev/null 2>&1)
    if [ $? -eq 0 ]; then
        (systemctl status maverick-mavros-fc >/dev/null 2>&1); statusout+=$(status "Mavros (Flight Controller)" $?)
    fi
    (systemctl status maverick-visiond >/dev/null 2>&1); statusout+=$(status "Maverick Vision" $?)
    if [ "$environment" == "dev" ]; then
        statusout+='--------------------: \n'
        (systemctl status dev-sitl >/dev/null 2>&1); statusout+=$(status "SITL" $?)
        $(systemctl -a |grep mavproxy-sitl >/dev/null 2>&1)
        if [ $? -eq 0 ]; then
            (systemctl status mavproxy-sitl >/dev/null 2>&1); statusout+=$(status "Mavproxy (SITL)" $?)
        fi
        $(systemctl -a |grep mavros-sitl >/dev/null 2>&1)
        if [ $? -eq 0 ]; then
            (systemctl status maverick-mavros-sitl >/dev/null 2>&1); statusout+=$(status "Mavros (SITL)" $?)
        fi
        (systemctl status cloud9 >/dev/null 2>&1); statusout+=$(status "Cloud9 IDE" $?)
    fi
    echo -e $statusout | column -c 2 -s : -t
    echo
    exit 0
fi

# Read environment marker if it exists
if [ -e /srv/maverick/.environment ]; then
    environment=$(cat /srv/maverick/.environment)
    if [[ $environment && "$ENV" != "" ]]; then
        echo "Environment marker set but is being ignored as --env is set"
    elif [[ "$environment" == "bootstrap" || "$environment" == "dev" || "$environment" == "production" ]]; then
        echo "Environment marker set and is being used to set maverick environment: ${environment}"
        ENV=$environment
    else
        echo "Environment marker set but not recognised"
    fi
fi

# If environment not set to dev or production, exit
if [[ "$ENV" != "dev" && "$ENV" != "production" && "$ENV" != "bootstrap" ]]; then 
    echo "Error: --env not set to a recognised environment (bootstrap, dev or production)"
    echo
    usage
fi

# If configure not set, exit
if [ "$CONFIGURE" != "true" ]; then	
    echo "Error: --configure not set"
    echo
    usage
fi

# Check that puppet is installed
if ! hash puppet 2>/dev/null; then
    echo 'Puppet not installed, attempting to install..'
    if hash apt-get 2>/dev/null; then
        if [ $EUID -eq 0 ]; then
            DEBIAN_FRONTEND=noninteractive apt-get -y install puppet >/dev/null 2>&1
        elif [ $USER == "mav" ]; then
            sudo DEBIAN_FRONTEND=noninteractive apt-get -y install puppet >/dev/null 2>&1
        fi
        if hash puppet; then
            puppetinstalled=true
        fi
    fi
else
    puppetinstalled=true
fi
if ! $puppetinstalled; then
    echo 'Error: Puppet not installed and could not be installed'
    echo
    exit 1
fi

# Check that python is installed
if ! hash python 2>/dev/null; then
    echo 'Python not installed, attempting to install..'
    if hash apt-get 2>/dev/null; then
        if [ $EUID -eq 0 ]; then
            DEBIAN_FRONTEND=noninteractive apt-get -y install python >/dev/null 2>&1
        elif [ $USER == "mav" ]; then
            sudo DEBIAN_FRONTEND=noninteractive apt-get -y install python >/dev/null 2>&1
        fi
        if hash python; then
            pythoninstalled=true
        fi
    fi
else
    pythoninstalled=true
fi
if ! $pythoninstalled; then
    echo 'Error: Python not installed and could not be installed'
    echo
    exit 1
fi

# If git is installed at this point, then force git to ignore any changes to localconf.json
#  in the current directory, which might contain sensitive information
if hash git 2>/dev/null; then
    if [[ $EUID -eq 0 && $SUDO_USER != "" && $SUDO_USER != "root" && -e conf/localconf.json ]]; then
        su $SUDO_USER -c "git update-index --assume-unchanged conf/localconf.json"
    fi
fi

# Kludge to address #60: Remove upstart before we run puppet as it gets upset
#  with broken upstart/init setup
ubuntu=$(/bin/grep 'DISTRIB_DESCRIPTION\="Ubuntu 15.10"' /etc/lsb-release 2>/dev/null)
upstart=$(which upstart)
if [[ "$ubuntu" != "" && "$upstart" != "" ]]; then
	echo "Removing broken ubuntu upstart"
	sudo dpkg --purge unity-greeter upstart >/dev/null 2>&1
fi

# OK we're good to go!
#echo "Environment: ${ENV}"
mavenv ${ENV}
echo 'Proceeding to update system configuration - please be patient, this can take a while..'
if [ -e ./conf/puppet.conf ]; then
    if [ $EUID -eq 0 ]; then
        puppet apply --confdir=conf --environment ${ENV} manifests
    elif [ $USER == "mav" ]; then
        sudo puppet apply --confdir=conf --environment ${ENV} manifests
    fi
elif [ -e /srv/maverick/software/maverick/conf/puppet.conf ]; then
    cwd=$(pwd)
    cd /srv/maverick/software/maverick
    if [ $EUID -eq 0 ]; then
        puppet apply --confdir=conf --environment ${ENV} manifests
    elif [ $USER == "mav" ]; then
        sudo puppet apply --confdir=conf --environment ${ENV} manifests
    fi
    cd $cwd
else
    echo "Error: Maverick software not found in current directory or expected location: /srv/maverick/software/maverick"
    exit 1
fi

# If bootstrap environment, print a reboot warning
if [ $ENV == "bootstrap" ]; then
    echo
    echo "-------------------------"
    echo "WARNING: If this is the first bootstrap run, please reboot NOW to activate system changes."
    echo "If system is not rebooted after first bootstrap run, further runs may not work as expected."
    echo "-------------------------"
fi

# Finish up
echo
echo "Maverick finished, happy flying :)"
echo
