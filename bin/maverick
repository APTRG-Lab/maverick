#!/bin/bash

# Maverick - UAV Companion Computer system
# http://github.com/fnoop/maverick

# If tput is available, populate colour variables
if hash tput 2>/dev/null; then
    bgbl=$(tput setab 0)
    bgr=$(tput setab 1)
    bgg=$(tput setab 2)
    bgb=$(tput setab 4)
    bgw=$(tput setab 7)
    bold=$(tput bold)
    red=$(tput setaf 1)
    green=$(tput setaf 2)
    blue=$(tput setaf 4)
    white=$(tput setaf 7)
    reset=$(tput sgr0)
fi

echo
echo "${bgb}${bold}Maverick - UAV Companion Computer Automation${reset}"
echo

# Check that we're root or mav user
if [[ $EUID -ne 0 && $USER != "mav" ]]; then
    echo "Error: This must be run as root or mav user"
    echo
    exit 1
fi

# Define usage function
usage () {
    echo "maverick [--options] command"
    echo
    echo "Options"
    echo " --env=[bootstrap|dev|flight]              Environment to configure: bootstrap, dev or flight"
    echo " --dryrun                                  Configure dry run - just show what would be done"
    echo
    echo "Commands"
    echo " status                                  Show current running status"
    echo " info                                    Display system information"
    echo " netinfo                                 Display network information"
    echo " self-update                             Update to latest maverick code"
    echo " configure                               Configure system - ${bold}BEWARE this may do major changes to your existing system${reset}"
    echo " start                                   Start Maverick service"
    echo " stop                                    Stop Maverick service"
    echo " restart                                 Restart Maverick service"
    echo " enable                                  Enable Maverick service at boot"
    echo " disable                                 Disable Maverick service at boot"
    echo
    echo "${bgr}${bold}WARNING: Maverick may make major changes to the system is it running on.${reset}"
    echo "${bgr}${bold}Please do not run without understanding what it does.${reset}"
    echo
    exit 1
}

if [[ $# -eq 0 ]] ; then
    usage
fi

# Parse arguments
for i in "$@"
do
    case $i in
        --env=*)
            ENV="${i#*=}"
            shift
            ;;
        --dryrun)
            DRYRUN="--noop"
            shift
            ;;
        configure)
            CONFIGURE="true"
            shift
            ;;
        status)
            STATUS="true"
            shift
            ;;
        info)
            INFO="true"
            shift
            ;;
        netinfo)
            NETINFO="true"
            shift
            ;;
        self-update)
            SELFUPDATE="true"
            shift
            ;;
        start)
            START="true"
            shift
            ;;
        stop)
            STOP="true"
            shift
            ;;
        restart)
            RESTART="true"
            shift
            ;;
        enable)
            ENABLE="true"
            shift
            ;;
        disable)
            DISABLE="true"
            shift
            ;;
        *)
            # If stop or start action, grab the service name from next argument
            if [ "${START}" == "true" -o "${STOP}" == "true" -o "${RESTART}" == "true" -o "${ENABLE}" == "true" -o "${DISABLE}" == "true" ]; then
                SERVICE="${i#*}"
                shift
            else
                echo "Error: argument not recognised"
                echo
                usage
            fi
            ;;
    esac
done

mavenv () {
    if [ "x$1" == "xdev" ]; then
        echo "Maverick Environment:   ${bgr}${white}${bold} dev ${reset}"
    elif [ "x$1" == "xflight" ]; then
        echo "Maverick Environment:   ${bgg}${white}${bold} flight ${reset}"
    elif [ "x$1" == "xbootstrap" ]; then
        echo "Maverick Environment:   ${bgb}${white}${bold} bootstrap ${reset}"
    fi    
}

# If self-update set, action and then exit
if [ "$SELFUPDATE" == "true" ]; then
    if [ -e /srv/maverick/software/maverick/conf/puppet.conf ]; then
        if [ $EUID -eq 0 ]; then
            su mav -c "cd /srv/maverick/software/maverick; git pull origin"
        elif [ $USER == "mav" ]; then
            cd /srv/maverick/software/maverick; git pull origin;
        fi
        echo
        echo "${bgg}Maverick update completed${reset}"
        echo
    else
        echo
        echo "${bgr}Error: Maverick not found in expected location: /srv/maverick/software/maverick${reset}"
        echo
    fi
    exit 0
fi

# If info set, action and then exit
if [ "$INFO" == "true" ]; then
    if [ -e /srv/maverick/.environment ]; then
        environment=$(cat /srv/maverick/.environment)
    fi
    mavenv ${environment}
    echo
    /usr/bin/python /srv/maverick/software/maverick/bin/maverick-info
    echo
    exit 0
fi

# If netinfo set, action and then exit
if [ "$NETINFO" == "true" ]; then
    if [ -e /srv/maverick/.environment ]; then
        environment=$(cat /srv/maverick/.environment)
    fi
    mavenv ${environment}
    echo
    /usr/bin/python /srv/maverick/software/maverick/bin/maverick-netinfo
    echo
    exit 0
fi

# If status set, action and then exit
if [ "$STATUS" == "true" ]; then
    status () {
        if [ $3 -eq 0 ]; then
            _status="${green}Running${reset}"
        else
            _status="${red}Stopped${reset}"
        fi
        if [ $4 -eq 0 ]; then
            _atboot="${green}Enabled${reset}"
        else
            _atboot="${red}Disabled${reset}"
        fi
        echo "$1:$2:$_status | $_atboot\n"
    }
    if [ -e /srv/maverick/.environment ]; then
        environment=$(cat /srv/maverick/.environment)
    fi
    mavenv ${environment}
    echo
    statusout+="Service:Description: Status | At Boot\n"
    statusout+="------------:------------:------------------\n"
    mavfc=1
    mavfcen=1
    mavfcservice="<not set>"
    for mavtype in "mavproxy" "cmavnode" "mavlink-router"; do
        $(systemctl is-enabled "maverick-$mavtype@fc" >/dev/null 2>&1)
        if [ $? -eq 0 ]; then
            $(systemctl status "maverick-$mavtype@fc" >/dev/null 2>&1)
            if [ $? -eq 0 ]; then
                mavfc=0
            else
                mavfc=1
            fi
            mavfcservice="$mavtype@fc"
            mavfcen=0
        fi
    done
    statusout+=$(status "${mavfcservice}" "Mavlink (FC)" $mavfc $mavfcen)
    (systemctl status maverick-mavros-fc >/dev/null 2>&1); mavrosfc=$?; (systemctl is-enabled maverick-mavros-fc >/dev/null 2>&1); mavrosfcen=$?; statusout+=$(status "mavros-fc" "Mavros (FC)" $mavrosfc $mavrosfcen)
    (systemctl status maverick-visiond >/dev/null 2>&1); vis=$?; (systemctl is-enabled maverick-visiond >/dev/null 2>&1); visen=$?; statusout+=$(status "visiond" "Maverick Vision" $vis $visen)
    if [ "$environment" == "dev" ]; then
        statusout+='------------:------------:------------------\n'
        (systemctl status maverick-sitl >/dev/null 2>&1); sitl=$?; (systemctl is-enabled maverick-sitl >/dev/null 2>&1); sitlen=$?; statusout+=$(status "sitl" "SITL" $sitl $sitlen)
        mavsitl=1
        mavsitlen=1
        mavsitlservice="<not set>"
        for mavtype in "mavproxy" "cmavnode" "mavlink-router"; do
            $(systemctl is-enabled "maverick-$mavtype@sitl" >/dev/null 2>&1)
            if [ $? -eq 0 ]; then
                $(systemctl status "maverick-$mavtype@sitl" >/dev/null 2>&1)
                if [ $? -eq 0 ]; then
                    mavsitl=0
                else
                    mavsitl=1
                fi
                mavsitlservice="$mavtype@sitl"
                mavsitlen=0
            fi
        done
        statusout+=$(status "${mavsitlservice}" "Mavlink (SITL)" $mavsitl $mavsitlen)
        (systemctl status maverick-mavros-sitl >/dev/null 2>&1); mavrossitl=$?; (systemctl is-enabled maverick-mavros-sitl >/dev/null 2>&1); mavrossitlen=$?; statusout+=$(status "mavros-sitl" "Mavros (SITL)" $mavrossitl $mavrossitlen)
        (systemctl status maverick-cloud9 >/dev/null 2>&1); c9=$?; (systemctl is-enabled maverick-cloud9 >/dev/null 2>&1); c9en=$?; statusout+=$(status "cloud9" "Cloud9 IDE" $c9 $c9en)
    fi
    echo -e $statusout | column -c 3 -s : -t
    echo
    exit 0
fi

startservice() {
    srvresult=$(sudo systemctl start "maverick-$1" 2>&1)
    if [ $? -eq 0 ]; then
        echo " Start: ${green}Success${reset}"
    else
        echo " Start: ${red}Failure${reset}: $srvresult"
    fi  
}

stopservice() {
    srvresult=$(sudo systemctl stop "maverick-$1" 2>&1)
    if [ $? -eq 0 ]; then
        echo " Stop: ${green}Success${reset}"
    else
        echo " Stop: ${red}Failure${reset}: $srvresult"
    fi
}

# If start requested, action and then exit
if [ "$START" == "true" ]; then
    echo "Starting service: ${SERVICE}"
    startservice "${SERVICE}"
    echo
    exit 0
fi

# If stop requested, action and then exit
if [ "$STOP" == "true" ]; then
    echo "Stopping service: ${SERVICE}"
    stopservice ${SERVICE}
    echo
    exit 0
fi

# If restart requested, action stop then start
if [ "$RESTART" == "true" ]; then
    echo "Restarting service: ${SERVICE}"
    stopservice ${SERVICE}
    startservice ${SERVICE}
    echo
    exit 0
fi

# If enable requested, action and then exit
if [ "$ENABLE" == "true" ]; then
    echo "Enabling service: ${SERVICE}"
    srvresult=$(sudo systemctl enable "maverick-${SERVICE}" 2>&1)
    if [ $? -eq 0 ]; then
        echo " Enable: ${green}Success${reset}"
    else
        echo " Enable: ${red}Failure${reset}: $srvresult"
    fi
    echo
    exit 0
fi

# If disable requested, action and then exit
if [ "$DISABLE" == "true" ]; then
    echo "Disabling service: ${SERVICE}"
    srvresult=$(sudo systemctl disable "maverick-${SERVICE}" 2>&1)
    if [ $? -eq 0 ]; then
        echo " Disable: ${green}Success${reset}"
    else
        echo " Disable: ${red}Failure${reset}: $srvresult"
    fi
    echo
    exit 0
fi

# Read environment marker if it exists
if [ -e /srv/maverick/.environment ]; then
    environment=$(cat /srv/maverick/.environment)
    if [[ $environment && "$ENV" != "" ]]; then
        echo "Environment marker set but is being ignored as --env is set"
    elif [[ "$environment" == "bootstrap" || "$environment" == "dev" || "$environment" == "flight" ]]; then
        echo "Environment marker set and is being used to set maverick environment: ${environment}"
        ENV=$environment
    else
        echo "Environment marker set but not recognised"
    fi
fi

# If environment not set to dev or flight, exit
if [[ "$ENV" != "dev" && "$ENV" != "flight" && "$ENV" != "bootstrap" ]]; then 
    echo "Error: --env not set to a recognised environment (bootstrap, dev or flight)"
    echo
    usage
fi

# If configure not set, exit
if [ "$CONFIGURE" != "true" ]; then	
    echo "Error: configure not set"
    echo
    usage
fi

# Check that puppet is installed
if ! hash puppet 2>/dev/null; then
    echo 'Puppet not installed, attempting to install..'
    if hash apt-get 2>/dev/null; then
        if [ $EUID -eq 0 ]; then
            DEBIAN_FRONTEND=noninteractive apt-get -y install puppet >/dev/null 2>&1
        elif [ $USER == "mav" ]; then
            sudo DEBIAN_FRONTEND=noninteractive apt-get -y install puppet >/dev/null 2>&1
        fi
        if hash puppet; then
            puppetinstalled=true
        fi
    fi
else
    puppetinstalled=true
fi
if ! $puppetinstalled; then
    echo 'Error: Puppet not installed and could not be installed'
    echo
    exit 1
fi

# Check that python is installed
if ! hash python 2>/dev/null; then
    echo 'Python not installed, attempting to install..'
    if hash apt-get 2>/dev/null; then
        if [ $EUID -eq 0 ]; then
            DEBIAN_FRONTEND=noninteractive apt-get -y install python >/dev/null 2>&1
        elif [ $USER == "mav" ]; then
            sudo DEBIAN_FRONTEND=noninteractive apt-get -y install python >/dev/null 2>&1
        fi
        if hash python; then
            pythoninstalled=true
        fi
    fi
else
    pythoninstalled=true
fi
if ! $pythoninstalled; then
    echo 'Error: Python not installed and could not be installed'
    echo
    exit 1
fi

# If git is installed at this point, then force git to ignore any changes to localconf.json
#  in the current directory, which might contain sensitive information
if hash git 2>/dev/null; then
    if [[ $EUID -eq 0 && $SUDO_USER != "" && $SUDO_USER != "root" && -e conf/localconf.json ]]; then
        su $SUDO_USER -c "git update-index --assume-unchanged conf/localconf.json"
    fi
fi

# Kludge to address #60: Remove upstart before we run puppet as it gets upset
#  with broken upstart/init setup
#ubuntu=$(/bin/grep -e 'DISTRIB_DESCRIPTION\="Ubuntu 1[56]' /etc/lsb-release 2>/dev/null)
#upstart=$(which upstart)
#if [[ "$ubuntu" != "" && "$upstart" != "" ]]; then
#	echo "Removing broken ubuntu upstart"
#	sudo dpkg --purge unity-greeter upstart >/dev/null 2>&1
#fi

# OK we're good to go!
mavenv ${ENV}
if [ "x${DRYRUN}" == "x" ]; then
    echo "${bgbl}${bold}${red}Proceeding to update system configuration - please be patient, this can take a while..${reset}"
    RUNMODE="--no-noop"
else
    echo "${bgbl}${bold}${green}Dry run requested, running configure in a readonly/nondestructive mode${reset}"
    RUNMODE="--noop"
fi
echo

if [ -e ./conf/puppet.conf ]; then
    if [ $EUID -eq 0 ]; then
        puppet apply --confdir=conf --environment ${ENV} $RUNMODE manifests
    elif [ $USER == "mav" ]; then
        sudo puppet apply --confdir=conf --environment ${ENV} $RUNMODE manifests
    fi
elif [ -e /srv/maverick/software/maverick/conf/puppet.conf ]; then
    cwd=$(pwd)
    cd /srv/maverick/software/maverick
    if [ $EUID -eq 0 ]; then
        puppet apply --confdir=conf --environment ${ENV} $RUNMODE manifests
    elif [ $USER == "mav" ]; then
        sudo puppet apply --confdir=conf --environment ${ENV} $RUNMODE manifests
    fi
    cd $cwd
else
    echo "Error: Maverick software not found in current directory or expected location: /srv/maverick/software/maverick"
    exit 1
fi

# If maverick not running from expected home assume we want to migrate local-node files
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
if [ x"$DIR" != x"/srv/maverick/software/maverick/bin" ]; then
    cp -unp $DIR/../conf/local-nodes/*.json /srv/maverick/software/maverick/conf/local-nodes >/dev/null 2>&1
fi

# If bootstrap environment, print a reboot warning
if [ $ENV == "bootstrap" ]; then
    echo
    echo "-------------------------"
    echo "WARNING: If this is the first bootstrap run, please reboot NOW to activate system changes."
    echo "If system is not rebooted after first bootstrap run, further runs may not work as expected."
    echo "After reboot, login as 'mav' user - default password is 'wingman'"
    echo "-------------------------"
fi

# Finish up
echo
echo "Maverick finished, happy flying :)"
echo
